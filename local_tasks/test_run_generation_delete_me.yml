---

- name: Load our vars file
  include_vars:
    file: "{{ vars_file }}"
    name: env_vars

- name: Set our vars in global
  set_fact:
    "{{ item.key }}": "{{ item.value }}"
  with_dict: "{{ env_vars }}"

- name: Debug our env_vars
  debug:
    msg: "{{ env_vars }}"

- name: Load our common vars
  include_vars:
    file: "{{ playbook_dir }}/tmptest/common.yycredentials.yml"
    name: common_vars

- name: Debug our common_vars
  debug:
    msg: "{{ common_vars }}"

- name: Export our products
  set_fact:
    products: "{{ common_vars.products }}"

- name: Export our account
  set_fact:
    account: "{{ common_vars.account }}"

- name: Export our account
  set_fact:
    env_products: "{{ env_vars.products }}"

- name: Debug our env_products
  debug:
    msg: "{{ env_products }}"

- name: Debug our products
  debug:
    msg: "{{ products }}"

- name: dump our products
  debug:
    msg: "{{ common_vars.products,  env_vars.products  }}"

- name: Export our combined_products
  set_fact:
    combined_products: "{{ common_vars.products | merge_and_update_dictionary(default=env_vars.products)  }}"
    #combined_products: "{{ common_vars.products | merge_config_dictionaries(default=env_vars.products)  }}"
    # msg: "{{ right.stuff.0|merge_and_update_dictionary(default=left.stuff.0) }}"

- name: Export our combined_products
  set_fact:
    combined_products: "{{ common_vars | merge_config_dictionaries(env_vars)  }}"

- name: Debug our combined_products
  debug:
    msg: "{{ combined_products }}"

- name: Output what we are running
  debug:
    msg: "Running generation for {{ vars_file|basename|replace('.yaml', '')|replace('.yml', '') }}"

# - name: Generate our secrets
#   include_role:
#     name: "{{ playbook_dir }}/roles/roles/credentials"
